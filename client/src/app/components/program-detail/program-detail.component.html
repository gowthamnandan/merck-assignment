<div>
      @if (loading()) {
        <div class="d-flex justify-content-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      } @else if (program()) {
        <!-- Back + Actions -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <button cButton color="secondary" variant="outline" size="sm" (click)="goBack()">
            <svg class="me-1" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Back to Programs
          </button>
          @if (auth.isManager()) {
            <div class="d-flex gap-2">
              @if (!editing()) {
                <button cButton color="primary" size="sm" (click)="startEdit()">
                  <svg class="me-1" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  Edit Program
                </button>
              } @else {
                <button cButton color="success" size="sm" (click)="saveEdit()" [disabled]="saving()">
                  {{ saving() ? 'Saving...' : 'Save Changes' }}
                </button>
                <button cButton color="secondary" size="sm" (click)="cancelEdit()">Cancel</button>
              }
            </div>
          }
        </div>

        <!-- Program Header Card -->
        <c-card class="mb-4">
          <c-card-body>
            @if (!editing()) {
              <!-- Read mode -->
              <div class="d-flex align-items-center gap-2 mb-2">
                <small class="text-body-secondary font-monospace">{{ program()!.code }}</small>
                <c-badge [color]="getPhaseColor(program()!.phase)">{{ program()!.phase }}</c-badge>
                <c-badge [color]="getStatusColor(program()!.status)">{{ program()!.status }}</c-badge>
              </div>
              <h4 class="mb-3">{{ program()!.name }}</h4>
              @if (program()!.description) {
                <p class="text-body-secondary mb-4">{{ program()!.description }}</p>
              }
              <c-row class="g-3">
                <c-col cols="6" lg="3">
                  <small class="text-body-secondary d-block">Therapeutic Area</small>
                  <span class="fw-medium">{{ program()!.therapeutic_area }}</span>
                </c-col>
                <c-col cols="6" lg="3">
                  <small class="text-body-secondary d-block">Indication</small>
                  <span class="fw-medium">{{ program()!.indication }}</span>
                </c-col>
                <c-col cols="6" lg="3">
                  <small class="text-body-secondary d-block">Molecule Type</small>
                  <span class="fw-medium">{{ program()!.molecule_type || '—' }}</span>
                </c-col>
                <c-col cols="6" lg="3">
                  <small class="text-body-secondary d-block">Target</small>
                  <span class="fw-medium">{{ program()!.target || '—' }}</span>
                </c-col>
                <c-col cols="6" lg="3">
                  <small class="text-body-secondary d-block">Lead</small>
                  <span class="fw-medium">{{ program()!.lead || '—' }}</span>
                </c-col>
                <c-col cols="6" lg="3">
                  <small class="text-body-secondary d-block">Start Date</small>
                  <span class="fw-medium">{{ program()!.start_date || '—' }}</span>
                </c-col>
                <c-col cols="6" lg="3">
                  <small class="text-body-secondary d-block">Expected End</small>
                  <span class="fw-medium">{{ program()!.expected_end_date || '—' }}</span>
                </c-col>
              </c-row>
            } @else {
              <!-- Edit mode -->
              <h5 class="mb-4">Edit Program</h5>
              <c-row class="g-3">
                <c-col md="6">
                  <label cLabel>Name</label>
                  <input cFormControl type="text" [(ngModel)]="editData.name" />
                </c-col>
                <c-col md="6">
                  <label cLabel>Phase</label>
                  <select cFormSelect [(ngModel)]="editData.phase">
                    @for (p of phases; track p) { <option [value]="p">{{ p }}</option> }
                  </select>
                </c-col>
                <c-col md="6">
                  <label cLabel>Status</label>
                  <select cFormSelect [(ngModel)]="editData.status">
                    @for (s of statuses; track s) { <option [value]="s">{{ s }}</option> }
                  </select>
                </c-col>
                <c-col md="6">
                  <label cLabel>Therapeutic Area</label>
                  <input cFormControl type="text" [(ngModel)]="editData.therapeutic_area" />
                </c-col>
                <c-col md="6">
                  <label cLabel>Indication</label>
                  <input cFormControl type="text" [(ngModel)]="editData.indication" />
                </c-col>
                <c-col md="6">
                  <label cLabel>Molecule Type</label>
                  <input cFormControl type="text" [(ngModel)]="editData.molecule_type" />
                </c-col>
                <c-col md="6">
                  <label cLabel>Target</label>
                  <input cFormControl type="text" [(ngModel)]="editData.target" />
                </c-col>
                <c-col md="6">
                  <label cLabel>Lead</label>
                  <input cFormControl type="text" [(ngModel)]="editData.lead" />
                </c-col>
                <c-col md="6">
                  <label cLabel>Start Date</label>
                  <input cFormControl type="date" [(ngModel)]="editData.start_date" />
                </c-col>
                <c-col md="6">
                  <label cLabel>Expected End Date</label>
                  <input cFormControl type="date" [(ngModel)]="editData.expected_end_date" />
                </c-col>
                <c-col cols="12">
                  <label cLabel>Description</label>
                  <textarea cFormControl [(ngModel)]="editData.description" rows="3"></textarea>
                </c-col>
              </c-row>
            }
          </c-card-body>
        </c-card>

        @if (successMessage()) {
          <c-alert color="success" class="mb-4" [dismissible]="true">{{ successMessage() }}</c-alert>
        }

        <!-- Tabs -->
        <ul cNav variant="tabs" class="mb-4">
          <c-nav-item>
            <a cNavLink [active]="activeTab() === 'studies'" (click)="activeTab.set('studies')" style="cursor:pointer;">
              Studies ({{ program()!.studies.length }})
            </a>
          </c-nav-item>
          <c-nav-item>
            <a cNavLink [active]="activeTab() === 'milestones'" (click)="activeTab.set('milestones')" style="cursor:pointer;">
              Milestones ({{ program()!.milestones.length }})
            </a>
          </c-nav-item>
        </ul>

        <!-- Studies Tab -->
        @if (activeTab() === 'studies') {
          @for (study of program()!.studies; track study.id) {
            <c-card class="mb-3">
              <c-card-body>
                <c-row>
                  <c-col lg="9">
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <small class="text-body-secondary font-monospace">{{ study.protocol_number }}</small>
                      <c-badge [color]="getStatusColor(study.status)">{{ study.status }}</c-badge>
                    </div>
                    <h6 class="mb-2">{{ study.name }}</h6>
                    @if (study.description) {
                      <p class="text-body-secondary small mb-3">{{ study.description }}</p>
                    }
                    <c-row class="g-3">
                      <c-col cols="6" sm="3">
                        <small class="text-body-secondary d-block">Phase</small>
                        <span class="fw-medium small">{{ study.phase }}</span>
                      </c-col>
                      <c-col cols="6" sm="3">
                        <small class="text-body-secondary d-block">Sites</small>
                        <span class="fw-medium small">{{ study.sites_count }}</span>
                      </c-col>
                      <c-col cols="6" sm="3">
                        <small class="text-body-secondary d-block">Countries</small>
                        <span class="fw-medium small">{{ study.countries || '—' }}</span>
                      </c-col>
                      <c-col cols="6" sm="3">
                        <small class="text-body-secondary d-block">Start Date</small>
                        <span class="fw-medium small">{{ study.start_date || '—' }}</span>
                      </c-col>
                    </c-row>
                  </c-col>
                  <c-col lg="3" class="mt-3 mt-lg-0">
                    <small class="text-body-secondary d-block mb-1">Enrollment</small>
                    <div class="d-flex align-items-end gap-1 mb-1">
                      <span class="fs-4 fw-bold">{{ study.current_enrollment | number }}</span>
                      <small class="text-body-secondary mb-1">/ {{ study.target_enrollment | number }}</small>
                    </div>
                    <c-progress [value]="getEnrollmentPct(study)"
                                [color]="getEnrollmentColor(study)" style="height: 6px;" class="mb-1"></c-progress>
                    <small class="text-body-secondary">{{ getEnrollmentPct(study) | number:'1.0-0' }}% enrolled</small>
                  </c-col>
                </c-row>
              </c-card-body>
            </c-card>
          }
          @if (program()!.studies.length === 0) {
            <div class="text-center py-5 text-body-secondary">No studies found for this program</div>
          }
        }

        <!-- Milestones Tab -->
        @if (activeTab() === 'milestones') {
          <c-card>
            <c-card-body class="p-0">
              <div class="table-responsive">
                <table cTable hover striped small class="mb-0">
                  <thead>
                    <tr>
                      <th>Milestone</th>
                      <th>Category</th>
                      <th>Status</th>
                      <th>Planned Date</th>
                      <th>Actual Date</th>
                      @if (auth.isManager()) { <th>Action</th> }
                    </tr>
                  </thead>
                  <tbody>
                    @for (m of program()!.milestones; track m.id) {
                      <tr>
                        <td>
                          <span class="fw-medium">{{ m.title }}</span>
                          @if (m.description) {
                            <br><small class="text-body-secondary">{{ m.description }}</small>
                          }
                        </td>
                        <td><c-badge [color]="getCategoryColor(m.category)">{{ m.category }}</c-badge></td>
                        <td>
                          @if (editingMilestone() === m.id) {
                            <select cFormSelect size="sm" [(ngModel)]="editMilestoneStatus" style="width: auto;">
                              <option value="Pending">Pending</option>
                              <option value="In Progress">In Progress</option>
                              <option value="Completed">Completed</option>
                              <option value="Delayed">Delayed</option>
                              <option value="Cancelled">Cancelled</option>
                            </select>
                          } @else {
                            <c-badge [color]="getMilestoneStatusColor(m.status)">{{ m.status }}</c-badge>
                          }
                        </td>
                        <td class="text-body-secondary">{{ m.planned_date || '—' }}</td>
                        <td>
                          @if (editingMilestone() === m.id) {
                            <input cFormControl type="date" size="sm" [(ngModel)]="editMilestoneDate" style="width: auto;" />
                          } @else {
                            <span class="text-body-secondary">{{ m.actual_date || '—' }}</span>
                          }
                        </td>
                        @if (auth.isManager()) {
                          <td>
                            @if (editingMilestone() === m.id) {
                              <div class="d-flex gap-2">
                                <button cButton color="success" size="sm" variant="ghost" (click)="saveMilestone(m)">Save</button>
                                <button cButton color="secondary" size="sm" variant="ghost" (click)="editingMilestone.set(null)">Cancel</button>
                              </div>
                            } @else {
                              <button cButton color="primary" size="sm" variant="ghost" (click)="startEditMilestone(m)">Edit</button>
                            }
                          </td>
                        }
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
              @if (program()!.milestones.length === 0) {
                <div class="text-center py-5 text-body-secondary">No milestones found</div>
              }
            </c-card-body>
          </c-card>
        }
      } @else {
        <div class="text-center py-5">
          <p class="fs-5 text-body-secondary">Program not found</p>
          <a routerLink="/programs" class="text-primary text-decoration-none small mt-2 d-inline-block">Back to programs</a>
        </div>
      }
    </div>